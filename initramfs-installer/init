#!/bin/sh
#
# Coyote Linux 4 - Installer Initramfs Init Script
#
# Simplified init for the installer environment. This script:
# 1. Mounts basic filesystems
# 2. Loads storage/filesystem modules
# 3. Finds and mounts the installer media
# 4. Pivots to the installer rootfs
#

# Don't use set -e as PID 1 must never exit unexpectedly

# Paths
export INSTALLER_MEDIA=""
export INSTALLER_MEDIA_TYPE=""
export NEWROOT="/newroot"

# Colors for output
log() {
    printf '\033[0;32m[INIT]\033[0m %s\n' "$1"
}

warn() {
    printf '\033[1;33m[WARN]\033[0m %s\n' "$1"
}

error() {
    printf '\033[0;31m[ERROR]\033[0m %s\n' "$1"
}

# Emergency shell for recovery
emergency_shell() {
    error "Installer boot failed! Dropping to emergency shell."
    error "Type 'exit' to attempt to continue."
    /bin/sh
}

# Run init scripts in order
run_init_scripts() {
    local script
    local failed=0

    for script in /init.d/[0-9][0-9]-*.sh; do
        [ -f "$script" ] || continue
        if [ -x "$script" ]; then
            log "Running: ${script##*/}"
            if ! . "$script"; then
                error "Script failed: ${script##*/}"
                failed=1
                break
            fi
        fi
    done

    return $failed
}

# Main boot sequence
main() {
    log "Coyote Linux 4 Installer - Starting"

    # Run init scripts
    if ! run_init_scripts; then
        emergency_shell
        log "Attempting to continue..."
    fi

    # Check if we have a newroot to pivot to
    if [ ! -d "${NEWROOT}/sbin" ]; then
        error "Installer rootfs not available!"
        emergency_shell
        while true; do
            error "PID 1 cannot exit. Restarting shell..."
            /bin/sh
        done
    fi

    # Pivot to the installer root
    log "Starting installer environment..."

    # Move mounts to new root
    mount --move /dev "${NEWROOT}/dev" 2>/dev/null || true
    mount --move /proc "${NEWROOT}/proc" 2>/dev/null || true
    mount --move /sys "${NEWROOT}/sys" 2>/dev/null || true

    # Switch to installer root - use installer-init instead of OpenRC
    # This avoids starting unnecessary services in installer mode
    exec switch_root "${NEWROOT}" /sbin/installer-init

    # If switch_root fails
    error "switch_root failed!"
    while true; do
        emergency_shell
    done
}

main "$@"
