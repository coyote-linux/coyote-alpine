#!/bin/sh
#
# Coyote Linux 4 - Initramfs PID 1 Init Script
#
# This script runs as PID 1 in the initramfs environment and handles:
# 1. Basic filesystem setup
# 2. Firmware image detection and validation
# 3. Recovery menu access
# 4. Pivot root to firmware
#

# Don't use set -e as PID 1 must never exit unexpectedly

# Paths
export BOOT_MEDIA=""
export BOOT_MEDIA_TYPE=""
export FIRMWARE_PATH=""
export CONFIG_PATH="/mnt/config"
export NEWROOT="/mnt/newroot"

# Colors for output (using printf for portability)
log() {
    printf '\033[0;32m[INIT]\033[0m %s\n' "$1"
}

warn() {
    printf '\033[1;33m[WARN]\033[0m %s\n' "$1"
}

error() {
    printf '\033[0;31m[ERROR]\033[0m %s\n' "$1"
}

# Emergency shell for recovery
emergency_shell() {
    error "Boot failed! Dropping to emergency shell."
    error "Type 'exit' to attempt to continue boot."
    # Use exec to replace this process with sh
    /bin/sh
}

# Run init scripts in order
run_init_scripts() {
    local script
    local failed=0

    for script in /init.d/[0-9][0-9]-*.sh; do
        [ -f "$script" ] || continue
        if [ -x "$script" ]; then
            log "Running: ${script##*/}"
            if ! . "$script"; then
                error "Script failed: ${script##*/}"
                failed=1
                break
            fi
        fi
    done

    return $failed
}

# Main boot sequence
main() {
    log "Coyote Linux 4 - Starting boot sequence"

    # Run init scripts
    if ! run_init_scripts; then
        emergency_shell
        # If user exits shell, try to continue
        log "Attempting to continue boot..."
    fi

    # Check if we have a newroot to pivot to
    if [ ! -d "${NEWROOT}/sbin" ]; then
        error "No root filesystem available!"
        emergency_shell
        # Loop forever if shell exits - PID 1 must not exit
        while true; do
            error "PID 1 cannot exit. Restarting shell..."
            /bin/sh
        done
    fi

    # Pivot to the real root
    log "Pivoting to firmware root..."

    # Move mounts to new root
    mount --move /dev "${NEWROOT}/dev" 2>/dev/null || true
    mount --move /proc "${NEWROOT}/proc" 2>/dev/null || true
    mount --move /sys "${NEWROOT}/sys" 2>/dev/null || true

    # Switch to new root - this replaces PID 1
    exec switch_root "${NEWROOT}" /sbin/init

    # If switch_root fails, we end up here
    error "switch_root failed!"
    while true; do
        emergency_shell
    done
}

main "$@"
