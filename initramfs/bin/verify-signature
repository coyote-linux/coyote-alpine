#!/bin/sh
#
# verify-signature - Verify Ed25519 signature on a file
#
# Usage: verify-signature <file> [public-key]
#
# Returns 0 if signature is valid, 1 otherwise.
# If no signature file exists, returns 2.
#

FILE="$1"
PUBKEY="${2:-/etc/coyote/keys/firmware-signing.pub}"

if [ -z "$FILE" ]; then
    echo "Usage: verify-signature <file> [public-key]" >&2
    exit 1
fi

if [ ! -f "$FILE" ]; then
    echo "Error: File not found: $FILE" >&2
    exit 1
fi

SIGFILE="${FILE}.sig"

if [ ! -f "$SIGFILE" ]; then
    echo "No signature file: $SIGFILE" >&2
    exit 2
fi

if [ ! -f "$PUBKEY" ]; then
    echo "Error: Public key not found: $PUBKEY" >&2
    exit 1
fi

# Verify using openssl
if openssl pkeyutl -verify \
    -pubin -inkey "$PUBKEY" \
    -rawin \
    -in "$FILE" \
    -sigfile "$SIGFILE" >/dev/null 2>&1; then
    echo "OK"
    exit 0
else
    echo "FAILED"
    exit 1
fi
