#!/bin/bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/.config"
DIALOG_BIN="${DIALOG_BIN:-dialog}"

DEFAULT_KERNEL_TYPE="custom"
DEFAULT_DEV_BUILD="0"
DEFAULT_FIRMWARE_SIZE_MB="512"
DEFAULT_BOOT_PARTITION_SIZE_MIB="4096"
DEFAULT_DOTNET="1"
DEFAULT_LOADBALANCER="1"
DEFAULT_IPSEC="1"
DEFAULT_OPENVPN="1"
DEFAULT_WIREGUARD="1"

MIN_FIRMWARE_SIZE_MB="256"
MIN_BOOT_PARTITION_SIZE_MIB="512"

CONFIG_KERNEL_TYPE="$DEFAULT_KERNEL_TYPE"
CONFIG_DEV_BUILD="$DEFAULT_DEV_BUILD"
CONFIG_FIRMWARE_SIZE_MB="$DEFAULT_FIRMWARE_SIZE_MB"
CONFIG_BOOT_PARTITION_SIZE_MIB="$DEFAULT_BOOT_PARTITION_SIZE_MIB"
CONFIG_DOTNET="$DEFAULT_DOTNET"
CONFIG_LOADBALANCER="$DEFAULT_LOADBALANCER"
CONFIG_IPSEC="$DEFAULT_IPSEC"
CONFIG_OPENVPN="$DEFAULT_OPENVPN"
CONFIG_WIREGUARD="$DEFAULT_WIREGUARD"

TMP_FILE="$(mktemp)"
trap 'rm -f "$TMP_FILE"' EXIT

normalize_bool() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        1|y|yes|true|on|enabled) echo "1" ;;
        *) echo "0" ;;
    esac
}

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        . "$CONFIG_FILE"
    fi

    case "${CONFIG_KERNEL_TYPE}" in
        custom|alpine-lts) ;;
        *) CONFIG_KERNEL_TYPE="$DEFAULT_KERNEL_TYPE" ;;
    esac

    CONFIG_DEV_BUILD="$(normalize_bool "${CONFIG_DEV_BUILD:-$DEFAULT_DEV_BUILD}")"
    CONFIG_DOTNET="$(normalize_bool "${CONFIG_DOTNET:-$DEFAULT_DOTNET}")"
    CONFIG_LOADBALANCER="$(normalize_bool "${CONFIG_LOADBALANCER:-$DEFAULT_LOADBALANCER}")"
    CONFIG_IPSEC="$(normalize_bool "${CONFIG_IPSEC:-$DEFAULT_IPSEC}")"
    CONFIG_OPENVPN="$(normalize_bool "${CONFIG_OPENVPN:-$DEFAULT_OPENVPN}")"
    CONFIG_WIREGUARD="$(normalize_bool "${CONFIG_WIREGUARD:-$DEFAULT_WIREGUARD}")"

    case "${CONFIG_FIRMWARE_SIZE_MB:-}" in
        ''|*[!0-9]*) CONFIG_FIRMWARE_SIZE_MB="$DEFAULT_FIRMWARE_SIZE_MB" ;;
    esac

    case "${CONFIG_BOOT_PARTITION_SIZE_MIB:-}" in
        ''|*[!0-9]*) CONFIG_BOOT_PARTITION_SIZE_MIB="$DEFAULT_BOOT_PARTITION_SIZE_MIB" ;;
    esac

    if [ "$CONFIG_FIRMWARE_SIZE_MB" -lt "$MIN_FIRMWARE_SIZE_MB" ]; then
        CONFIG_FIRMWARE_SIZE_MB="$MIN_FIRMWARE_SIZE_MB"
    fi

    if [ "$CONFIG_BOOT_PARTITION_SIZE_MIB" -lt "$MIN_BOOT_PARTITION_SIZE_MIB" ]; then
        CONFIG_BOOT_PARTITION_SIZE_MIB="$MIN_BOOT_PARTITION_SIZE_MIB"
    fi
}

save_config() {
    cat > "$CONFIG_FILE" <<EOF
# Coyote Linux build configuration
# Generated by make menuconfig

CONFIG_KERNEL_TYPE=${CONFIG_KERNEL_TYPE}
CONFIG_DEV_BUILD=${CONFIG_DEV_BUILD}
CONFIG_FIRMWARE_SIZE_MB=${CONFIG_FIRMWARE_SIZE_MB}
CONFIG_BOOT_PARTITION_SIZE_MIB=${CONFIG_BOOT_PARTITION_SIZE_MIB}
CONFIG_DOTNET=${CONFIG_DOTNET}
CONFIG_LOADBALANCER=${CONFIG_LOADBALANCER}
CONFIG_IPSEC=${CONFIG_IPSEC}
CONFIG_OPENVPN=${CONFIG_OPENVPN}
CONFIG_WIREGUARD=${CONFIG_WIREGUARD}
EOF
}

bool_label() {
    if [ "$1" = "1" ]; then
        echo "Enabled"
    else
        echo "Disabled"
    fi
}

prompt_integer() {
    local title="$1"
    local prompt="$2"
    local current="$3"
    local minimum="$4"

    while true; do
        "$DIALOG_BIN" --backtitle "Coyote Linux Build Configuration" \
            --title "$title" \
            --inputbox "$prompt" 10 70 "$current" 2>"$TMP_FILE" || return 1

        local value
        value="$(cat "$TMP_FILE")"

        case "$value" in
            ''|*[!0-9]*)
                "$DIALOG_BIN" --msgbox "Please enter a numeric value." 7 40
                continue
                ;;
        esac

        if [ "$value" -lt "$minimum" ]; then
            "$DIALOG_BIN" --msgbox "Value must be at least ${minimum}." 7 45
            continue
        fi

        echo "$value"
        return 0
    done
}

configure_kernel_type() {
    local current="1"
    if [ "$CONFIG_KERNEL_TYPE" = "alpine-lts" ]; then
        current="2"
    fi

    "$DIALOG_BIN" --backtitle "Coyote Linux Build Configuration" \
        --title "Kernel Type" \
        --menu "Select kernel source for build artifacts:" 12 60 3 \
        "1" "Custom kernel (kernel/build-kernel.sh)" \
        "2" "Alpine LTS kernel package" \
        2>"$TMP_FILE" || return

    case "$(cat "$TMP_FILE")" in
        1) CONFIG_KERNEL_TYPE="custom" ;;
        2) CONFIG_KERNEL_TYPE="alpine-lts" ;;
    esac
}

configure_base_system() {
    while true; do
        "$DIALOG_BIN" --backtitle "Coyote Linux Build Configuration" \
            --title "Base System Options" \
            --menu "Configure firmware and installer sizing:" 14 72 5 \
            "1" "Firmware size limit (MB): ${CONFIG_FIRMWARE_SIZE_MB}" \
            "2" "Boot partition size (MiB): ${CONFIG_BOOT_PARTITION_SIZE_MIB}" \
            "3" "Back" \
            2>"$TMP_FILE" || return

        case "$(cat "$TMP_FILE")" in
            1)
                value="$(prompt_integer "Firmware Size Limit" "Maximum allowed firmware squashfs size in MB (minimum ${MIN_FIRMWARE_SIZE_MB})." "$CONFIG_FIRMWARE_SIZE_MB" "$MIN_FIRMWARE_SIZE_MB")" || true
                if [ -n "$value" ]; then
                    CONFIG_FIRMWARE_SIZE_MB="$value"
                fi
                ;;
            2)
                value="$(prompt_integer "Boot Partition Size" "Boot partition size in MiB for NEW installs only (minimum ${MIN_BOOT_PARTITION_SIZE_MIB})." "$CONFIG_BOOT_PARTITION_SIZE_MIB" "$MIN_BOOT_PARTITION_SIZE_MIB")" || true
                if [ -n "$value" ]; then
                    CONFIG_BOOT_PARTITION_SIZE_MIB="$value"
                fi
                ;;
            3)
                return
                ;;
        esac
    done
}

configure_additional_options() {
    "$DIALOG_BIN" --backtitle "Coyote Linux Build Configuration" \
        --title "Additional Options" \
        --separate-output \
        --checklist "Toggle optional platform components:" 16 76 8 \
        "DOTNET" "Dotnet 10 runtime" "$([ "$CONFIG_DOTNET" = "1" ] && echo on || echo off)" \
        "LOADBALANCER" "Load balancer (HAProxy)" "$([ "$CONFIG_LOADBALANCER" = "1" ] && echo on || echo off)" \
        "IPSEC" "IPSec VPN (StrongSwan)" "$([ "$CONFIG_IPSEC" = "1" ] && echo on || echo off)" \
        "OPENVPN" "OpenVPN server" "$([ "$CONFIG_OPENVPN" = "1" ] && echo on || echo off)" \
        "WIREGUARD" "WireGuard server" "$([ "$CONFIG_WIREGUARD" = "1" ] && echo on || echo off)" \
        2>"$TMP_FILE" || return

    CONFIG_DOTNET="0"
    CONFIG_LOADBALANCER="0"
    CONFIG_IPSEC="0"
    CONFIG_OPENVPN="0"
    CONFIG_WIREGUARD="0"

    while IFS= read -r selected || [ -n "$selected" ]; do
        selected="$(echo "$selected" | tr -d '"')"
        case "$selected" in
            DOTNET) CONFIG_DOTNET="1" ;;
            LOADBALANCER) CONFIG_LOADBALANCER="1" ;;
            IPSEC) CONFIG_IPSEC="1" ;;
            OPENVPN) CONFIG_OPENVPN="1" ;;
            WIREGUARD) CONFIG_WIREGUARD="1" ;;
        esac
    done < "$TMP_FILE"
}

show_main_menu() {
    while true; do
        "$DIALOG_BIN" --backtitle "Coyote Linux Build Configuration" \
            --title "Coyote Menuconfig" \
            --menu "Select an item to configure:" 20 82 10 \
            "1" "Kernel type: ${CONFIG_KERNEL_TYPE}" \
            "2" "Development mode: $(bool_label "$CONFIG_DEV_BUILD")" \
            "3" "Base system options" \
            "4" "Additional options" \
            "5" "Save and exit" \
            "6" "Exit without saving" \
            2>"$TMP_FILE" || return 1

        case "$(cat "$TMP_FILE")" in
            1)
                configure_kernel_type
                ;;
            2)
                if [ "$CONFIG_DEV_BUILD" = "1" ]; then
                    CONFIG_DEV_BUILD="0"
                else
                    CONFIG_DEV_BUILD="1"
                fi
                ;;
            3)
                configure_base_system
                ;;
            4)
                configure_additional_options
                ;;
            5)
                save_config
                "$DIALOG_BIN" --msgbox "Configuration saved to ${CONFIG_FILE}" 7 70
                return 0
                ;;
            6)
                if "$DIALOG_BIN" --yesno "Discard changes and exit?" 7 40; then
                    return 1
                fi
                ;;
        esac
    done
}

main() {
    if ! command -v "$DIALOG_BIN" >/dev/null 2>&1; then
        echo "Error: '${DIALOG_BIN}' is required for menuconfig"
        echo "Install it and rerun 'make menuconfig'"
        exit 1
    fi

    load_config
    show_main_menu
}

main "$@"
