#!/usr/bin/lua5.4
--
-- MRTG Setup Script
-- Generates MRTG configuration for network interfaces and system resources
--

local MRTG_CFG = "/etc/mrtg/mrtg.cfg"
local MRTG_DIR = "/var/www/mrtg"
local MRTG_WORKDIR = "/var/lib/mrtg"

-- Execute a shell command
local function exec(cmd)
    local handle = io.popen(cmd .. " 2>/dev/null")
    if handle then
        local result = handle:read("*a")
        handle:close()
        return result
    end
    return nil
end

-- Create directory if it doesn't exist
local function mkdir(path)
    os.execute("mkdir -p " .. path)
end

-- Remove files matching pattern
local function rm_files(pattern)
    os.execute("rm -f " .. pattern .. " 2>/dev/null")
end

-- Get list of network interfaces (excluding loopback)
local function get_interfaces()
    local interfaces = {}
    local handle = io.popen("ls -1 /sys/class/net/ 2>/dev/null")
    if handle then
        for line in handle:lines() do
            if line ~= "lo" and line ~= "" then
                table.insert(interfaces, line)
            end
        end
        handle:close()
    end
    return interfaces
end

-- Get interface speed in bytes/sec (default 1Gbps)
local function get_interface_speed(iface)
    local speed_file = "/sys/class/net/" .. iface .. "/speed"
    local f = io.open(speed_file, "r")
    if f then
        local speed_raw = f:read("*l") or ""
        f:close()
        local speed_mbps = tonumber(speed_raw) or tonumber(speed_raw:match("(%d+)") or "")
        if speed_mbps and speed_mbps > 0 then
            return speed_mbps * 125000  -- Convert Mbps to bytes/sec
        end
    end
    return 125000000  -- Default 1Gbps in bytes/sec
end

-- Generate the MRTG configuration file
local function generate_config()
    local f = io.open(MRTG_CFG, "w")
    if not f then
        print("Error: Cannot write to " .. MRTG_CFG)
        os.exit(1)
    end

    -- Write global options
    f:write([[
######################################################################
# MRTG Configuration - Auto-generated by Coyote Linux
######################################################################

# Global Options
WorkDir: ]] .. MRTG_DIR .. [[

WriteExpires: Yes
RunAsDaemon: No
EnableIPv6: no
LogFormat: rrdtool

######################################################################
# CPU Usage
######################################################################

Target[cpu]: `/opt/coyote/bin/mrtg-cpu`
Title[cpu]: CPU Usage
PageTop[cpu]: <h1>CPU Usage</h1>
MaxBytes[cpu]: 100
ShortLegend[cpu]: %
YLegend[cpu]: CPU Usage (%)
Legend1[cpu]: User + System CPU (%)
Legend2[cpu]: User CPU (%)
LegendI[cpu]: Total:
LegendO[cpu]: User:
Options[cpu]: growright,gauge,nopercent
Unscaled[cpu]: dwmy

######################################################################
# Memory Usage
######################################################################

Target[memory]: `/opt/coyote/bin/mrtg-memory`
Title[memory]: Memory Usage
PageTop[memory]: <h1>Memory Usage</h1>
MaxBytes[memory]: 100
ShortLegend[memory]: %
YLegend[memory]: Memory Usage (%)
Legend1[memory]: Used Memory (%)
Legend2[memory]: Used + Buffers/Cache (%)
LegendI[memory]: Used:
LegendO[memory]: Total:
Options[memory]: growright,gauge,nopercent
Unscaled[memory]: dwmy

]])

    -- Add network interfaces
    local interfaces = get_interfaces()
    for _, iface in ipairs(interfaces) do
        local speed = get_interface_speed(iface)
        f:write(string.format([[
######################################################################
# Network Interface: %s
######################################################################

Target[%s]: `/opt/coyote/bin/mrtg-net %s`
Title[%s]: Traffic Analysis for %s
PageTop[%s]: <h1>Traffic Analysis for %s</h1>
MaxBytes[%s]: %d
ShortLegend[%s]: B/s
YLegend[%s]: Bytes per Second
Legend1[%s]: Incoming Traffic (bytes/sec)
Legend2[%s]: Outgoing Traffic (bytes/sec)
LegendI[%s]: In:
LegendO[%s]: Out:
Options[%s]: growright,bits

]], iface, iface, iface, iface, iface, iface, iface, iface, speed,
    iface, iface, iface, iface, iface, iface, iface))
    end

    f:close()
    print("MRTG configuration generated: " .. MRTG_CFG)
end

-- Run MRTG with proper environment
local function run_mrtg()
    local cmd = "env LANG=C /usr/bin/mrtg " .. MRTG_CFG
    local ret = os.execute(cmd .. " 2>&1")
    return ret == 0 or ret == true
end

-- Main
print("Setting up MRTG monitoring...")

-- Create directories
mkdir(MRTG_DIR)
mkdir(MRTG_WORKDIR)
mkdir("/etc/mrtg")

-- Clean old MRTG data files to prevent StepTime mismatch errors
print("Cleaning old MRTG data files...")
rm_files(MRTG_DIR .. "/*.log")
rm_files(MRTG_DIR .. "/*.old")
rm_files("/tmp/mrtg-cpu.state")

-- Generate configuration
generate_config()

-- Create index page if indexmaker is available
print("Creating index page...")
os.execute("env LANG=C indexmaker --output=" .. MRTG_DIR .. "/index.html " .. MRTG_CFG .. " 2>/dev/null")

-- Run MRTG multiple times to initialize (MRTG needs 2-3 runs to stabilize)
print("Initializing MRTG (this requires multiple runs)...")
for i = 1, 3 do
    print("  Run " .. i .. "/3...")
    run_mrtg()
    if i < 3 then
        os.execute("sleep 2")
    end
end

-- Generate initial graphs
print("Generating graphs...")
os.execute("/opt/coyote/bin/mrtg-graphs")

print("")
print("MRTG setup complete")
print("Graphs available at: /mrtg/")
print("Cron job updates data and graphs every 5 minutes")
