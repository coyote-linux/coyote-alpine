#!/bin/sh
#
# MRTG Setup Script
# Generates MRTG configuration for network interfaces and system resources
#

MRTG_CFG="/etc/mrtg/mrtg.cfg"
MRTG_DIR="/var/www/mrtg"
MRTG_WORKDIR="/var/lib/mrtg"

# Create directories
mkdir -p "$MRTG_DIR" "$MRTG_WORKDIR"

# Get list of network interfaces (excluding loopback)
get_interfaces() {
    for iface in /sys/class/net/*; do
        [ -d "$iface" ] || continue
        name=$(basename "$iface")
        [ "$name" = "lo" ] && continue
        echo "$name"
    done
}

# Generate MRTG configuration
generate_config() {
    cat > "$MRTG_CFG" << 'HEADER'
######################################################################
# MRTG Configuration - Auto-generated by Coyote Linux
######################################################################

# Global Options
WorkDir: /var/www/mrtg
WriteExpires: Yes
RunAsDaemon: No
Interval: 5
Refresh: 300
EnableIPv6: no

# HTML styling
HtmlHead: <link rel="stylesheet" href="/assets/css/mrtg.css" type="text/css">
BodyTag: <body bgcolor="#1a1a2e" text="#eee" link="#4a9eff" vlink="#3a8eef">

HEADER

    # CPU Usage
    cat >> "$MRTG_CFG" << 'CPU'
######################################################################
# CPU Usage
######################################################################

Target[cpu]: `/opt/coyote/bin/mrtg-cpu`
Title[cpu]: CPU Usage
PageTop[cpu]: <h1>CPU Usage</h1>
MaxBytes[cpu]: 100
ShortLegend[cpu]: %
YLegend[cpu]: CPU Usage (%)
Legend1[cpu]: User + System CPU (%)
Legend2[cpu]: User CPU (%)
LegendI[cpu]: Total:
LegendO[cpu]: User:
Options[cpu]: growright,gauge,nopercent
Colours[cpu]: GREEN#4caf50,BLUE#4a9eff,DARK GREEN#2e7d32,VIOLET#9c27b0
Unscaled[cpu]: dwmy

CPU

    # Memory Usage
    cat >> "$MRTG_CFG" << 'MEMORY'
######################################################################
# Memory Usage
######################################################################

Target[memory]: `/opt/coyote/bin/mrtg-memory`
Title[memory]: Memory Usage
PageTop[memory]: <h1>Memory Usage</h1>
MaxBytes[memory]: 100
ShortLegend[memory]: %
YLegend[memory]: Memory Usage (%)
Legend1[memory]: Used Memory (%)
Legend2[memory]: Used + Buffers/Cache (%)
LegendI[memory]: Used:
LegendO[memory]: Total:
Options[memory]: growright,gauge,nopercent
Colours[memory]: GREEN#4caf50,BLUE#4a9eff,DARK GREEN#2e7d32,VIOLET#9c27b0
Unscaled[memory]: dwmy

MEMORY

    # Network Interfaces
    for iface in $(get_interfaces); do
        # Get interface speed (default to 1Gbps if unknown)
        speed=125000000  # 1Gbps in bytes/sec
        if [ -f "/sys/class/net/$iface/speed" ]; then
            link_speed=$(cat "/sys/class/net/$iface/speed" 2>/dev/null)
            if [ -n "$link_speed" ] && [ "$link_speed" -gt 0 ] 2>/dev/null; then
                speed=$((link_speed * 125000))  # Convert Mbps to bytes/sec
            fi
        fi

        cat >> "$MRTG_CFG" << IFACE
######################################################################
# Network Interface: $iface
######################################################################

Target[$iface]: /sys/class/net/$iface/statistics/rx_bytes:/sys/class/net/$iface/statistics/tx_bytes:UNKNOWN:UNKNOWN
Title[$iface]: Traffic Analysis for $iface
PageTop[$iface]: <h1>Traffic Analysis for $iface</h1>
MaxBytes[$iface]: $speed
ShortLegend[$iface]: B/s
YLegend[$iface]: Bytes per Second
Legend1[$iface]: Incoming Traffic (bytes/sec)
Legend2[$iface]: Outgoing Traffic (bytes/sec)
LegendI[$iface]: In:
LegendO[$iface]: Out:
Options[$iface]: growright,bits
Colours[$iface]: GREEN#4caf50,BLUE#4a9eff,DARK GREEN#2e7d32,VIOLET#9c27b0

IFACE
    done

    echo "MRTG configuration generated: $MRTG_CFG"
}

# Main
generate_config

# Create index page
if command -v indexmaker >/dev/null 2>&1; then
    indexmaker --output="$MRTG_DIR/index.html" "$MRTG_CFG" 2>/dev/null || true
fi

# Run MRTG once to initialize (creates log files)
if command -v mrtg >/dev/null 2>&1; then
    # Run 3 times to initialize properly (MRTG needs this)
    mrtg "$MRTG_CFG" 2>/dev/null || true
    sleep 1
    mrtg "$MRTG_CFG" 2>/dev/null || true
    sleep 1
    mrtg "$MRTG_CFG" 2>/dev/null || true
fi

echo "MRTG setup complete"
