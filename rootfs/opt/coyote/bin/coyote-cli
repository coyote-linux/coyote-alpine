#!/usr/bin/env php
<?php
/**
 * Coyote Linux CLI - Main command-line interface
 */

require_once '/opt/coyote/lib/autoload.php';

use Coyote\Config\ConfigManager;
use Coyote\Firewall\FirewallManager;
use Coyote\Vpn\VpnManager;
use Coyote\LoadBalancer\LoadBalancerManager;

/**
 * Display usage information
 */
function showUsage(): void
{
    echo "Coyote Linux CLI\n";
    echo "\n";
    echo "Usage: coyote-cli <command> [options]\n";
    echo "\n";
    echo "Commands:\n";
    echo "  config load          Load configuration from persistent storage\n";
    echo "  config save          Save running configuration to persistent storage\n";
    echo "  config show          Display current running configuration\n";
    echo "  config validate      Validate current configuration\n";
    echo "\n";
    echo "  firewall status      Show firewall status\n";
    echo "  vpn status           Show VPN tunnel status\n";
    echo "  lb status            Show load balancer status\n";
    echo "\n";
    echo "  status               Show system status\n";
    echo "  version              Show version information\n";
    echo "\n";
}

/**
 * Show system status
 */
function showStatus(): void
{
    $hardware = new \Coyote\System\Hardware();

    echo "Coyote Linux System Status\n";
    echo "==========================\n\n";

    // CPU
    $cpu = $hardware->getCpuInfo();
    echo "CPU: {$cpu['model']} ({$cpu['cores']} cores)\n";

    // Memory
    $mem = $hardware->getMemoryInfo();
    $totalMB = round($mem['total'] / 1024 / 1024);
    $availMB = round($mem['available'] / 1024 / 1024);
    echo "Memory: {$availMB}MB available / {$totalMB}MB total\n";

    // Network interfaces
    echo "\nNetwork Interfaces:\n";
    $interfaces = $hardware->detectNetworkInterfaces();
    foreach ($interfaces as $name => $info) {
        $state = $info['state'] ?? 'unknown';
        $mac = $info['mac'] ?? 'unknown';
        echo "  {$name}: {$state} ({$mac})\n";
    }

    echo "\n";
}

/**
 * Show version information
 */
function showVersion(): void
{
    echo "Coyote Linux 4.0.0\n";
    echo "Built on Alpine Linux\n";
}

// Main
$args = array_slice($argv, 1);

if (empty($args)) {
    showUsage();
    exit(0);
}

$command = $args[0];
$subcommand = $args[1] ?? '';

switch ($command) {
    case 'config':
        $configManager = new ConfigManager();

        switch ($subcommand) {
            case 'load':
                try {
                    $configManager->load();
                    echo "Configuration loaded.\n";
                } catch (\Exception $e) {
                    echo "Error loading configuration: " . $e->getMessage() . "\n";
                    exit(1);
                }
                break;

            case 'save':
                if ($configManager->save()) {
                    echo "Configuration saved.\n";
                } else {
                    echo "Error saving configuration.\n";
                    exit(1);
                }
                break;

            case 'show':
                $configManager->load();
                $config = $configManager->getRunningConfig();
                echo json_encode($config->toArray(), JSON_PRETTY_PRINT) . "\n";
                break;

            case 'validate':
                $configManager->load();
                $errors = $configManager->validate();
                if (empty($errors)) {
                    echo "Configuration is valid.\n";
                } else {
                    echo "Validation errors:\n";
                    foreach ($errors as $error) {
                        echo "  - {$error}\n";
                    }
                    exit(1);
                }
                break;

            default:
                echo "Unknown config command: {$subcommand}\n";
                exit(1);
        }
        break;

    case 'firewall':
        $fwManager = new FirewallManager();
        switch ($subcommand) {
            case 'status':
                $status = $fwManager->getStatus();
                echo "Firewall Status\n";
                echo "===============\n";
                echo "Enabled: " . ($status['enabled'] ? "Yes" : "No") . "\n";
                echo "Active Connections: " . ($status['connections']['count'] ?? 0) . "\n";
                break;
            default:
                echo "Unknown firewall command: {$subcommand}\n";
                exit(1);
        }
        break;

    case 'vpn':
        $vpnManager = new VpnManager();
        switch ($subcommand) {
            case 'status':
                $status = $vpnManager->getStatus();
                echo "VPN Status\n";
                echo "==========\n";
                echo "StrongSwan Running: " . ($status['ipsec']['running'] ? "Yes" : "No") . "\n";
                break;
            default:
                echo "Unknown vpn command: {$subcommand}\n";
                exit(1);
        }
        break;

    case 'lb':
        $lbManager = new LoadBalancerManager();
        switch ($subcommand) {
            case 'status':
                $status = $lbManager->getStatus();
                echo "Load Balancer Status\n";
                echo "====================\n";
                echo "Enabled: " . ($status['enabled'] ? "Yes" : "No") . "\n";
                echo "HAProxy Running: " . ($status['running'] ? "Yes" : "No") . "\n";
                break;
            default:
                echo "Unknown lb command: {$subcommand}\n";
                exit(1);
        }
        break;

    case 'status':
        showStatus();
        break;

    case 'version':
        showVersion();
        break;

    case 'help':
    case '--help':
    case '-h':
        showUsage();
        break;

    default:
        echo "Unknown command: {$command}\n";
        showUsage();
        exit(1);
}
