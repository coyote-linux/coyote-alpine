#!/usr/bin/lua5.4
--
-- MRTG Graph Generator
-- Generates PNG graphs and HTML pages from RRD database files
--

local MRTG_DIR = "/var/www/mrtg"

-- Graph time periods
local periods = {
    { name = "day",   seconds = 86400,    title = "Daily",   avg = "5 Minute" },
    { name = "week",  seconds = 604800,   title = "Weekly",  avg = "30 Minute" },
    { name = "month", seconds = 2592000,  title = "Monthly", avg = "2 Hour" },
    { name = "year",  seconds = 31536000, title = "Yearly",  avg = "1 Day" },
}

-- Color scheme
local COLOR_IN = "#4caf50"
local COLOR_OUT = "#4a9eff"
local COLOR_BG = "#1a1a2e"
local COLOR_CANVAS = "#16213e"
local COLOR_FONT = "#eeeeee"
local COLOR_GRID = "#0f3460"

-- Target configurations
local target_config = {
    cpu = {
        title = "CPU Usage",
        y_label = "Percent",
        legend_in = "Total CPU",
        legend_out = "User CPU",
        unit = "%",
        base = 1000,
        upper_limit = 100
    },
    memory = {
        title = "Memory Usage",
        y_label = "Percent",
        legend_in = "Used Memory",
        legend_out = "Used (excl. cache)",
        unit = "%",
        base = 1000,
        upper_limit = 100
    }
}

-- Execute a command (show errors for debugging)
local function exec(cmd)
    return os.execute(cmd)
end

-- Check if file exists
local function file_exists(path)
    local f = io.open(path, "r")
    if f then f:close() return true end
    return false
end

-- Get list of RRD files
local function get_rrd_files()
    local files = {}
    local handle = io.popen("ls -1 " .. MRTG_DIR .. "/*.rrd 2>/dev/null")
    if handle then
        for line in handle:lines() do
            local name = line:match("([^/]+)%.rrd$")
            if name then
                table.insert(files, name)
            end
        end
        handle:close()
    end
    return files
end

-- Get target config (default for network interfaces)
local function get_config(target)
    if target_config[target] then
        return target_config[target]
    end
    -- Default config for network interfaces
    return {
        title = "Traffic Analysis for " .. target,
        y_label = "Bits per Second",
        legend_in = "Incoming",
        legend_out = "Outgoing",
        unit = "b/s",
        base = 1000,
        upper_limit = nil
    }
end

-- Generate graphs for a target
local function generate_graphs(target)
    local rrd_file = MRTG_DIR .. "/" .. target .. ".rrd"
    local config = get_config(target)

    if not file_exists(rrd_file) then
        print("  Skipping " .. target .. " (no RRD file)")
        return false
    end

    print("  Generating graphs for: " .. target)

    for _, period in ipairs(periods) do
        local png_file = MRTG_DIR .. "/" .. target .. "-" .. period.name .. ".png"

        -- Build Y-axis limit options for percentage graphs
        local limit_opts = ""
        if config.upper_limit then
            limit_opts = string.format("--lower-limit 0 --upper-limit %d --rigid ", config.upper_limit)
        end

        local cmd = string.format(
            'rrdtool graph %s --start -%d --title "%s - %s" --vertical-label "%s" ' ..
            '--width 500 --height 150 --base %d %s' ..
            '--color BACK"%s" --color CANVAS"%s" --color FONT"%s" --color GRID"%s" --color MGRID"%s" ' ..
            'DEF:in=%s:ds0:AVERAGE DEF:out=%s:ds1:AVERAGE ' ..
            'AREA:in%s:"%s " LINE1:out%s:"%s"',
            png_file, period.seconds,
            config.title, period.title,
            config.y_label, config.base, limit_opts,
            COLOR_BG, COLOR_CANVAS, COLOR_FONT, COLOR_GRID, COLOR_GRID,
            rrd_file, rrd_file,
            COLOR_IN, config.legend_in,
            COLOR_OUT, config.legend_out
        )

        exec(cmd)
    end

    return true
end

-- Generate HTML page for a target
local function generate_html(target)
    local config = get_config(target)
    local html_file = MRTG_DIR .. "/" .. target .. ".html"

    local f = io.open(html_file, "w")
    if not f then
        print("  Cannot write " .. html_file)
        return
    end

    f:write(string.format([[<!DOCTYPE html>
<html>
<head>
    <title>%s</title>
    <meta http-equiv="refresh" content="300">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: %s; color: %s; margin: 0; padding: 1rem; }
        h1 { color: #4a9eff; border-bottom: 1px solid #0f3460; padding-bottom: 0.5rem; }
        h2 { color: #4a9eff; font-size: 1.1rem; margin-top: 1.5rem; }
        .graph { background: %s; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        img { max-width: 100%%; height: auto; }
        a { color: #4a9eff; }
    </style>
</head>
<body>
    <h1>%s</h1>
    <p><a href="/dashboard">&larr; Back to Dashboard</a></p>
]], config.title, COLOR_BG, COLOR_FONT, COLOR_CANVAS, config.title))

    for _, period in ipairs(periods) do
        f:write(string.format([[
    <div class="graph">
        <h2>%s Graph (%s Average)</h2>
        <img src="%s-%s.png" alt="%s">
    </div>
]], period.title, period.avg, target, period.name, period.title))
    end

    f:write([[
    <p style="margin-top: 2rem; color: #aaa; font-size: 0.9rem;">
        Generated by MRTG/RRDtool on Coyote Linux
    </p>
</body>
</html>
]])

    f:close()
end

-- Generate index page
local function generate_index(targets)
    local html_file = MRTG_DIR .. "/index.html"
    local f = io.open(html_file, "w")
    if not f then return end

    f:write(string.format([[<!DOCTYPE html>
<html>
<head>
    <title>MRTG Index</title>
    <meta http-equiv="refresh" content="300">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               background: %s; color: %s; margin: 0; padding: 1rem; }
        h1 { color: #4a9eff; }
        .graphs { display: flex; flex-wrap: wrap; gap: 1rem; }
        .graph-card { background: %s; border-radius: 8px; padding: 1rem; }
        .graph-card h3 { color: #4a9eff; margin: 0 0 0.5rem 0; font-size: 1rem; }
        a { color: #4a9eff; text-decoration: none; }
        img { max-width: 100%%; height: auto; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>MRTG Statistics</h1>
    <p><a href="/dashboard">&larr; Back to Dashboard</a></p>
    <div class="graphs">
]], COLOR_BG, COLOR_FONT, COLOR_CANVAS))

    for _, target in ipairs(targets) do
        local config = get_config(target)
        f:write(string.format([[
        <div class="graph-card">
            <h3>%s</h3>
            <a href="%s.html"><img src="%s-day.png" alt="%s"></a>
        </div>
]], config.title, target, target, config.title))
    end

    f:write([[
    </div>
</body>
</html>
]])
    f:close()
end

-- Main
print("Generating MRTG graphs and HTML pages...")

local targets = get_rrd_files()

if #targets == 0 then
    print("No RRD files found in " .. MRTG_DIR)
    print("Make sure MRTG has run at least once.")

    -- List what's in the directory for debugging
    print("\nContents of " .. MRTG_DIR .. ":")
    os.execute("ls -la " .. MRTG_DIR)
    os.exit(1)
end

print("Found targets: " .. table.concat(targets, ", "))

local successful = {}
for _, target in ipairs(targets) do
    if generate_graphs(target) then
        generate_html(target)
        table.insert(successful, target)
    end
end

if #successful > 0 then
    generate_index(successful)
end

print("\nGenerated graphs for: " .. (#successful > 0 and table.concat(successful, ", ") or "none"))
