#!/usr/bin/env php
<?php
/**
 * apply-config - Apply system configuration
 *
 * This script reads the running configuration and applies it to the system,
 * including network interface configuration, DNS, hostname, and timezone.
 */

require_once '/opt/coyote/lib/autoload.php';

use Coyote\Config\ConfigManager;

/**
 * Apply system configuration
 */
function applyConfig(): bool
{
    $configManager = new ConfigManager();
    $errors = [];

    // Debug: Check mount status
    $configPath = '/mnt/config';
    $configFile = $configPath . '/system.json';

    echo "  Config path: {$configPath}\n";
    echo "  Config file: {$configFile}\n";

    // Check if config partition is mounted
    $mounts = file_get_contents('/proc/mounts');
    if (strpos($mounts, '/mnt/config') !== false) {
        echo "  Config partition: mounted\n";
    } else {
        echo "  Config partition: NOT MOUNTED\n";
        echo "  Attempting to find and mount config partition...\n";

        // Try to mount config partition
        foreach (glob('/dev/sd*2') + glob('/dev/nvme*p2') + glob('/dev/vd*2') as $part) {
            if (filetype($part) !== 'block') continue;

            // Try mounting (busybox mount requires -t type)
            exec("mount -t ext4 -o ro " . escapeshellarg($part) . " " . escapeshellarg($configPath) . " 2>&1", $output, $ret);
            if ($ret === 0) {
                if (file_exists($configFile)) {
                    echo "  Found config on: {$part}\n";
                    break;
                }
                exec("umount " . escapeshellarg($configPath) . " 2>&1");
            }
        }
    }

    if (file_exists($configFile)) {
        echo "  Config file: exists\n";
    } else {
        echo "  Config file: NOT FOUND (using defaults)\n";
    }

    // Load configuration
    try {
        $runningConfig = $configManager->load();
    } catch (\Exception $e) {
        echo "Error loading configuration: " . $e->getMessage() . "\n";
        return false;
    }

    $config = $runningConfig->toArray();

    // Debug: Show loaded config summary
    $ifaceCount = count($config['network']['interfaces'] ?? []);
    $dnsCount = is_array($config['network']['dns'] ?? null) ? count($config['network']['dns']) : 0;
    echo "  Loaded: {$ifaceCount} interface(s), {$dnsCount} DNS server(s)\n";

    // Apply hostname
    $hostname = $config['system']['hostname'] ?? 'coyote';
    $domain = $config['system']['domain'] ?? '';

    file_put_contents('/etc/hostname', $hostname . "\n");
    exec("hostname " . escapeshellarg($hostname));
    echo "  Hostname: {$hostname}\n";

    // Build /etc/hosts
    $fqdn = $domain ? "{$hostname}.{$domain}" : $hostname;
    $hosts = "127.0.0.1\tlocalhost\n";
    $hosts .= "127.0.1.1\t{$fqdn} {$hostname}\n";
    $hosts .= "::1\t\tlocalhost ip6-localhost ip6-loopback\n";
    file_put_contents('/etc/hosts', $hosts);

    // Apply timezone
    $tz = $config['system']['timezone'] ?? 'UTC';
    $tzFile = "/usr/share/zoneinfo/{$tz}";
    if (file_exists($tzFile)) {
        @unlink('/etc/localtime');
        @symlink($tzFile, '/etc/localtime');
        echo "  Timezone: {$tz}\n";
    }

    // Configure DNS (resolv.conf)
    $dns = $config['network']['dns'] ?? [];
    $search = $config['network']['search'] ?? [];

    // Ensure dns is a flat array of strings
    if (!is_array($dns)) {
        $dns = [$dns];
    }
    // Flatten in case of nested array
    $dnsServers = [];
    foreach ($dns as $ns) {
        if (is_array($ns)) {
            foreach ($ns as $server) {
                if (is_string($server) && !empty($server)) {
                    $dnsServers[] = $server;
                }
            }
        } elseif (is_string($ns) && !empty($ns)) {
            $dnsServers[] = $ns;
        }
    }

    // Ensure search is a flat array of strings
    if (!is_array($search)) {
        $search = !empty($search) ? [$search] : [];
    }
    $searchDomains = [];
    foreach ($search as $domain) {
        if (is_string($domain) && !empty($domain)) {
            $searchDomains[] = $domain;
        }
    }

    $resolv = "";
    if (!empty($searchDomains)) {
        $resolv .= "search " . implode(' ', $searchDomains) . "\n";
    }
    foreach ($dnsServers as $ns) {
        $resolv .= "nameserver {$ns}\n";
    }
    if (!empty($resolv)) {
        file_put_contents('/etc/resolv.conf', $resolv);
        echo "  DNS configured\n";
    }

    // Configure loopback interface
    echo "  Interface lo:\n";
    exec("ip addr add 127.0.0.1/8 dev lo 2>&1", $output, $ret);
    exec("ip link set lo up 2>&1", $output, $ret);
    if ($ret === 0) {
        echo "    Address: 127.0.0.1/8\n";
    } else {
        $errors[] = "Failed to configure loopback interface";
    }

    // Configure network interfaces
    $interfaces = $config['network']['interfaces'] ?? [];

    foreach ($interfaces as $ifaceConfig) {
        $name = $ifaceConfig['name'] ?? null;
        $address = $ifaceConfig['address'] ?? null;
        $gateway = $ifaceConfig['gateway'] ?? null;

        if (!$name) {
            continue;
        }

        echo "  Interface {$name}:\n";

        // Check if interface exists
        if (!file_exists("/sys/class/net/{$name}")) {
            echo "    WARNING: Interface {$name} not found\n";
            $errors[] = "Interface {$name} not found";
            continue;
        }

        // Flush existing addresses
        exec("ip addr flush dev " . escapeshellarg($name) . " 2>&1");

        // Bring interface up
        exec("ip link set " . escapeshellarg($name) . " up 2>&1", $output, $ret);
        if ($ret !== 0) {
            $errors[] = "Failed to bring up interface {$name}";
            continue;
        }

        // Set IP address (CIDR notation expected, e.g., 192.168.0.1/24)
        if ($address) {
            exec("ip addr add " . escapeshellarg($address) . " dev " . escapeshellarg($name) . " 2>&1", $output, $ret);
            if ($ret === 0) {
                echo "    Address: {$address}\n";
            } else {
                $errors[] = "Failed to set address on {$name}";
            }
        }

        // Set default gateway if specified
        if ($gateway) {
            // Remove existing default route first
            exec("ip route del default 2>&1");
            exec("ip route add default via " . escapeshellarg($gateway) . " dev " . escapeshellarg($name) . " 2>&1", $output, $ret);
            if ($ret === 0) {
                echo "    Gateway: {$gateway}\n";
            } else {
                $errors[] = "Failed to set default gateway";
            }
        }
    }

    // Enable IP forwarding (always enable for a firewall/router)
    exec('sysctl -w net.ipv4.ip_forward=1 2>&1');
    exec('sysctl -w net.ipv6.conf.all.forwarding=1 2>&1');

    // Report results
    if (!empty($errors)) {
        echo "\nConfiguration applied with errors:\n";
        foreach ($errors as $error) {
            echo "  - {$error}\n";
        }
        return false;
    }

    echo "\nConfiguration applied successfully.\n";
    return true;
}

// Main
echo "Applying Coyote Linux configuration...\n";
$success = applyConfig();
exit($success ? 0 : 1);
