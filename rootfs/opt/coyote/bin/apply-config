#!/usr/bin/env php
<?php
/**
 * apply-config - Apply system configuration
 *
 * This script reads a configuration file and applies it to the system,
 * including network interface configuration, DNS, hostname, and timezone.
 *
 * Environment variables:
 *   COYOTE_CONFIG_FILE - Path to config file to apply (default: auto-detect)
 *
 * When COYOTE_CONFIG_FILE is not set, it will:
 *   1. Look for /tmp/running-config/system.json (running config in RAM)
 *   2. Look for /mnt/config/system.json (persistent config)
 *   3. Use defaults if neither exists
 */

require_once '/opt/coyote/lib/autoload.php';

use Coyote\Config\ConfigLoader;

/**
 * Apply system configuration
 */
function applyConfig(): bool
{
    $loader = new ConfigLoader();
    $errors = [];

    // Check for explicit config file from environment
    $configFile = getenv('COYOTE_CONFIG_FILE');

    if ($configFile && file_exists($configFile)) {
        echo "  Using config file: {$configFile}\n";
        try {
            $config = $loader->load($configFile);
        } catch (\Exception $e) {
            echo "Error loading configuration: " . $e->getMessage() . "\n";
            return false;
        }
    } else {
        // Auto-detect config file
        $runningConfig = '/tmp/running-config/system.json';
        $persistentConfig = '/mnt/config/system.json';

        // Check running config first (already in RAM)
        if (file_exists($runningConfig)) {
            echo "  Using running config: {$runningConfig}\n";
            try {
                $config = $loader->load($runningConfig);
            } catch (\Exception $e) {
                echo "Error loading running config: " . $e->getMessage() . "\n";
                return false;
            }
        } elseif (file_exists($persistentConfig)) {
            echo "  Using persistent config: {$persistentConfig}\n";
            try {
                $config = $loader->load($persistentConfig);
            } catch (\Exception $e) {
                echo "Error loading persistent config: " . $e->getMessage() . "\n";
                return false;
            }
        } else {
            // Check if config partition is mounted
            $mounts = file_get_contents('/proc/mounts');
            if (strpos($mounts, '/mnt/config') === false) {
                echo "  Config partition: NOT MOUNTED\n";
                echo "  Attempting to find and mount config partition...\n";

                // Try to mount config partition
                foreach (glob('/dev/sd*2') + glob('/dev/nvme*p2') + glob('/dev/vd*2') as $part) {
                    if (filetype($part) !== 'block') continue;

                    // Try mounting (busybox mount requires -t type)
                    exec("mount -t ext4 -o ro " . escapeshellarg($part) . " /mnt/config 2>&1", $output, $ret);
                    if ($ret === 0) {
                        if (file_exists($persistentConfig)) {
                            echo "  Found config on: {$part}\n";
                            break;
                        }
                        exec("umount /mnt/config 2>&1");
                    }
                }
            }

            if (file_exists($persistentConfig)) {
                echo "  Using persistent config: {$persistentConfig}\n";
                try {
                    $config = $loader->load($persistentConfig);
                } catch (\Exception $e) {
                    echo "Error loading persistent config: " . $e->getMessage() . "\n";
                    return false;
                }
            } else {
                echo "  Config file: NOT FOUND (using defaults)\n";
                $config = getDefaults();
            }
        }
    }

    // Debug: Show loaded config summary
    $ifaceCount = count($config['network']['interfaces'] ?? []);
    $dnsCount = is_array($config['network']['dns'] ?? null) ? count($config['network']['dns']) : 0;
    echo "  Loaded: {$ifaceCount} interface(s), {$dnsCount} DNS server(s)\n";

    // Apply hostname
    $hostname = $config['system']['hostname'] ?? 'coyote';
    $domain = $config['system']['domain'] ?? '';

    file_put_contents('/etc/hostname', $hostname . "\n");
    exec("hostname " . escapeshellarg($hostname));
    echo "  Hostname: {$hostname}\n";

    // Build /etc/hosts
    $fqdn = $domain ? "{$hostname}.{$domain}" : $hostname;
    $hosts = "127.0.0.1\tlocalhost\n";
    $hosts .= "127.0.1.1\t{$fqdn} {$hostname}\n";
    $hosts .= "::1\t\tlocalhost ip6-localhost ip6-loopback\n";
    file_put_contents('/etc/hosts', $hosts);

    // Apply timezone
    $tz = $config['system']['timezone'] ?? 'UTC';
    $tzFile = "/usr/share/zoneinfo/{$tz}";
    if (file_exists($tzFile)) {
        @unlink('/etc/localtime');
        @symlink($tzFile, '/etc/localtime');
        echo "  Timezone: {$tz}\n";
    }

    // Configure DNS (resolv.conf)
    $dns = $config['network']['dns'] ?? [];
    $search = $config['network']['search'] ?? [];

    // Ensure dns is a flat array of strings
    if (!is_array($dns)) {
        $dns = [$dns];
    }
    // Flatten in case of nested array
    $dnsServers = [];
    foreach ($dns as $ns) {
        if (is_array($ns)) {
            foreach ($ns as $server) {
                if (is_string($server) && !empty($server)) {
                    $dnsServers[] = $server;
                }
            }
        } elseif (is_string($ns) && !empty($ns)) {
            $dnsServers[] = $ns;
        }
    }

    // Ensure search is a flat array of strings
    if (!is_array($search)) {
        $search = !empty($search) ? [$search] : [];
    }
    $searchDomains = [];
    foreach ($search as $domain) {
        if (is_string($domain) && !empty($domain)) {
            $searchDomains[] = $domain;
        }
    }

    $resolv = "";
    if (!empty($searchDomains)) {
        $resolv .= "search " . implode(' ', $searchDomains) . "\n";
    }
    foreach ($dnsServers as $ns) {
        $resolv .= "nameserver {$ns}\n";
    }
    if (!empty($resolv)) {
        file_put_contents('/etc/resolv.conf', $resolv);
        echo "  DNS configured\n";
    }

    // Configure loopback interface
    echo "  Interface lo:\n";
    exec("ip addr add 127.0.0.1/8 dev lo 2>&1", $output, $ret);
    exec("ip link set lo up 2>&1", $output, $ret);
    if ($ret === 0) {
        echo "    Address: 127.0.0.1/8\n";
    } else {
        $errors[] = "Failed to configure loopback interface";
    }

    // Configure network interfaces
    $interfaces = $config['network']['interfaces'] ?? [];

    foreach ($interfaces as $ifaceConfig) {
        $name = $ifaceConfig['name'] ?? null;
        $address = $ifaceConfig['address'] ?? null;
        $gateway = $ifaceConfig['gateway'] ?? null;

        if (!$name) {
            continue;
        }

        echo "  Interface {$name}:\n";

        // Check if interface exists
        if (!file_exists("/sys/class/net/{$name}")) {
            echo "    WARNING: Interface {$name} not found\n";
            $errors[] = "Interface {$name} not found";
            continue;
        }

        // Flush existing addresses
        exec("ip addr flush dev " . escapeshellarg($name) . " 2>&1");

        // Bring interface up
        exec("ip link set " . escapeshellarg($name) . " up 2>&1", $output, $ret);
        if ($ret !== 0) {
            $errors[] = "Failed to bring up interface {$name}";
            continue;
        }

        // Set IP address (CIDR notation expected, e.g., 192.168.0.1/24)
        if ($address) {
            exec("ip addr add " . escapeshellarg($address) . " dev " . escapeshellarg($name) . " 2>&1", $output, $ret);
            if ($ret === 0) {
                echo "    Address: {$address}\n";
            } else {
                $errors[] = "Failed to set address on {$name}";
            }
        }

        // Set default gateway if specified
        if ($gateway) {
            // Remove existing default route first
            exec("ip route del default 2>&1");
            exec("ip route add default via " . escapeshellarg($gateway) . " dev " . escapeshellarg($name) . " 2>&1", $output, $ret);
            if ($ret === 0) {
                echo "    Gateway: {$gateway}\n";
            } else {
                $errors[] = "Failed to set default gateway";
            }
        }
    }

    // Enable IP forwarding (always enable for a firewall/router)
    exec('sysctl -w net.ipv4.ip_forward=1 2>&1');
    exec('sysctl -w net.ipv6.conf.all.forwarding=1 2>&1');

    // Report results
    if (!empty($errors)) {
        echo "\nConfiguration applied with errors:\n";
        foreach ($errors as $error) {
            echo "  - {$error}\n";
        }
        return false;
    }

    // If this is a boot-time apply (not from ApplyService), update running-config
    $configFileEnv = getenv('COYOTE_CONFIG_FILE');
    if (!$configFileEnv) {
        writeRunningConfig($config);
    }

    echo "\nConfiguration applied successfully.\n";
    return true;
}

/**
 * Write configuration to running-config.
 *
 * @param array $config The configuration data
 */
function writeRunningConfig(array $config): void
{
    $runningConfigDir = '/tmp/running-config';
    $runningConfigFile = $runningConfigDir . '/system.json';

    if (!is_dir($runningConfigDir)) {
        mkdir($runningConfigDir, 0755, true);
    }

    $json = json_encode($config, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
    file_put_contents($runningConfigFile, $json);

    // Set ownership for web admin access
    @chown($runningConfigFile, 'lighttpd');
    @chgrp($runningConfigFile, 'lighttpd');

    echo "  Running config updated: {$runningConfigFile}\n";
}

/**
 * Get default configuration values.
 */
function getDefaults(): array
{
    $defaultsFile = '/opt/coyote/defaults/system.json';

    if (file_exists($defaultsFile)) {
        $loader = new ConfigLoader();
        return $loader->load($defaultsFile);
    }

    return [
        'system' => [
            'hostname' => 'coyote',
            'timezone' => 'UTC',
        ],
        'network' => [
            'interfaces' => [],
            'routes' => [],
            'dns' => [],
        ],
        'services' => [],
    ];
}

// Main
echo "Applying Coyote Linux configuration...\n";
$success = applyConfig();
exit($success ? 0 : 1);
