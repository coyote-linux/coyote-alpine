#!/sbin/openrc-run
#
# Coyote Linux Web Administration Interface
#

description="Coyote Web Administration Interface"
name="coyote-webadmin"

depend() {
    need coyote-config
    after networking
}

start_pre() {
    # lighttpd user/group created during build - verify it exists
    if ! id -u lighttpd >/dev/null 2>&1; then
        eerror "lighttpd user does not exist"
        return 1
    fi

    # Ensure log directory exists
    checkpath --directory --owner lighttpd:lighttpd --mode 0755 /var/log/lighttpd

    # Ensure socket directory exists
    checkpath --directory --owner lighttpd:lighttpd --mode 0755 /var/run/lighttpd

    # Ensure SSL directory exists
    mkdir -p /etc/lighttpd/ssl

    # Ensure SSL certificate exists
    if [ ! -f /etc/lighttpd/ssl/server.pem ]; then
        einfo "Generating self-signed SSL certificate..."
        openssl req -new -x509 -days 3650 -nodes \
            -out /etc/lighttpd/ssl/server.pem \
            -keyout /etc/lighttpd/ssl/server.pem \
            -subj "/CN=$(hostname)/O=Coyote Linux/C=US" 2>/dev/null
        chown lighttpd:lighttpd /etc/lighttpd/ssl/server.pem
        chmod 600 /etc/lighttpd/ssl/server.pem
    fi
}

start() {
    ebegin "Starting Coyote Web Admin"
    start-stop-daemon --start --exec /usr/sbin/lighttpd -- -f /etc/lighttpd/lighttpd.conf
    eend $?
}

stop() {
    ebegin "Stopping Coyote Web Admin"
    start-stop-daemon --stop --exec /usr/sbin/lighttpd
    eend $?
}

reload() {
    ebegin "Reloading Coyote Web Admin"
    start-stop-daemon --stop --signal HUP --exec /usr/sbin/lighttpd
    eend $?
}
